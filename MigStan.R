## equilibrium island model fit in Stan fo T knulli 
library(rstan)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

nL<-64650
nPop<-3

ff<-list.files(pattern="p_B")

Pmat<-matrix(NA,nrow=nL,ncol=nPop)
for(j in 1:nPop){
    pp<-read.table(ff[j],header=FALSE)
    Pmat[,j]<-pp[,3]
    }
Pmat[Pmat==0]<-0.0001
Pmat[Pmat==1]<-0.9999

snps<-read.table("Snps.txt",header=FALSE)

Pmat_sub<-Pmat[snps[,1] != 500,] ## drop LG 11

## kept 62,093

## four chains, 2000 steps, 1000 warup, thin = 1

Nm<-matrix(NA,nrow=10,ncol=10)
## repeat 10 times
for(x in 1:10){ ## 5000 SNPs at random
    dat<-list(L=5000,N=2,p=Pmat[sample(1:nL,5000,replace=FALSE),1:2])
    fit<-stan("beta_ismod.stan",data=dat)
    o<-summary(fit)
    Nm[x,]<-o[[1]][1,]
}    
colnames(Nm)<-names(o[[1]][1,])

round(Nm,3)
#       mean se_mean    sd  2.5%   25%   50%   75% 97.5%    n_eff  Rhat
# [1,] 5.343   0.002 0.108 5.133 5.268 5.343 5.415 5.561 2406.700 1.000
# [2,] 5.400   0.002 0.112 5.179 5.326 5.398 5.476 5.617 2275.568 1.001
# [3,] 5.162   0.002 0.107 4.957 5.086 5.162 5.234 5.373 2193.210 1.000
# [4,] 5.437   0.003 0.112 5.224 5.360 5.435 5.512 5.657 1877.306 1.002
# [5,] 5.145   0.002 0.107 4.943 5.071 5.143 5.218 5.355 2485.815 1.001
# [6,] 5.486   0.003 0.114 5.262 5.406 5.487 5.563 5.708 1983.688 0.999
# [7,] 5.231   0.002 0.110 5.016 5.155 5.229 5.304 5.450 2027.033 1.001
# [8,] 5.128   0.002 0.109 4.912 5.055 5.125 5.200 5.342 1953.677 1.000
# [9,] 5.326   0.002 0.109 5.116 5.251 5.326 5.400 5.545 2367.168 1.000
#[10,] 5.270   0.002 0.111 5.056 5.196 5.268 5.343 5.495 2107.093 1.000

Nm13<-matrix(NA,nrow=10,ncol=10)
## repeat 10 times
for(x in 1:10){ ## 5000 SNPs at random
    dat<-list(L=5000,N=2,p=Pmat[sample(1:nL,5000,replace=FALSE),c(1,3)])
    fit<-stan("beta_ismod.stan",data=dat)
    o<-summary(fit)
    Nm13[x,]<-o[[1]][1,]
}
colnames(Nm13)<-names(o[[1]][1,])
round(Nm13,3)
#      mean se_mean    sd  2.5%   25%   50%   75% 97.5%    n_eff  Rhat
# [1,] 0.663       0 0.015 0.634 0.653 0.663 0.674 0.692 2143.422 1.000
# [2,] 0.660       0 0.015 0.631 0.649 0.660 0.670 0.690 1717.584 1.001
# [3,] 0.677       0 0.015 0.648 0.667 0.677 0.688 0.706 1583.813 1.001
# [4,] 0.640       0 0.015 0.611 0.630 0.641 0.650 0.669 1680.439 1.003
# [5,] 0.669       0 0.015 0.639 0.658 0.669 0.679 0.698 1971.093 1.000
# [6,] 0.696       0 0.016 0.665 0.685 0.696 0.707 0.729 1872.088 1.000
# [7,] 0.660       0 0.015 0.632 0.650 0.660 0.670 0.691 1928.674 1.001
# [8,] 0.660       0 0.015 0.633 0.650 0.660 0.670 0.690 2016.284 1.001
# [9,] 0.659       0 0.015 0.631 0.649 0.659 0.669 0.689 1991.737 1.001
#[10,] 0.668       0 0.015 0.638 0.658 0.668 0.678 0.697 1740.835 1.003



Nm23<-matrix(NA,nrow=10,ncol=10)
## repeat 10 times
for(x in 1:10){ ## 5000 SNPs at random
    dat<-list(L=5000,N=2,p=Pmat[sample(1:nL,5000,replace=FALSE),c(2,3)])
    fit<-stan("beta_ismod.stan",data=dat)
    o<-summary(fit)
    Nm23[x,]<-o[[1]][1,]
}
colnames(Nm23)<-names(o[[1]][1,])
round(Nm23,3)
      mean se_mean    sd  2.5%   25%   50%   75% 97.5%    n_eff  Rhat
# [1,] 0.618       0 0.014 0.591 0.608 0.618 0.628 0.647 2053.157 1.001
# [2,] 0.655       0 0.015 0.627 0.645 0.655 0.666 0.685 1713.839 1.001
# [3,] 0.623       0 0.014 0.596 0.614 0.623 0.633 0.651 2308.600 1.000
# [4,] 0.621       0 0.014 0.595 0.611 0.621 0.631 0.650 2116.336 1.000
# [5,] 0.641       0 0.014 0.614 0.631 0.641 0.651 0.670 1987.491 1.003
# [6,] 0.612       0 0.013 0.586 0.602 0.611 0.620 0.639 2039.032 1.001
# [7,] 0.618       0 0.013 0.592 0.609 0.618 0.627 0.644 2115.514 1.001
# [8,] 0.651       0 0.014 0.624 0.641 0.651 0.660 0.679 2212.904 1.000
# [9,] 0.644       0 0.015 0.616 0.634 0.644 0.654 0.674 1842.428 1.001
#[10,] 0.652       0 0.015 0.624 0.643 0.652 0.662 0.682 1858.706 1.000

save(list=ls(),file="tknulMig.rdat")

